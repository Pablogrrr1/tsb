!function(a,b){"function"==typeof define&&define.amd?define(["lodash"],function(c){return b(c,a)}):"object"==typeof module&&module.exports?module.exports=b(require("lodash"),this):a.postal=b(a._,a)}(this,function(a,b,c){function d(){for(;s.length;)l.unsubscribe(s.shift())}function e(a,b,c){return function(d,e,f){d===a&&f.splice(e,1),0===f.length&&delete c[b]}}function f(a,b,c,d,e){var f=e&&e.headers||{};return function(e){var g;m.resolver.compare(e.topic,a,f)&&(f.resolverNoCache||(g=b[c]=b[c]||[],g.push(e),e.cacheKeys.push(c)),d&&d(e))}}function g(a,b){return{channel:m.SYSTEM_CHANNEL,topic:"subscription."+a,data:{event:"subscription."+a,channel:b.channel,topic:b.topic}}}function h(b,c){return"function"==typeof b?b:b?function(d){var e=0,f=0;return a.each(b,function(a,g){e+=1,("topic"===g&&c.compare(d.topic,b.topic,{resolverNoCache:!0})||"context"===g&&b.context===d._context||d[g]===b[g])&&(f+=1)}),e===f}:function(){return!0}}var i=b&&b.postal,j=b&&b._;j&&j!==a&&(a=a.noConflict());var k={DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"postal",enableSystemMessages:!0,cacheKeyDelimiter:"|",autoCompactResolver:!1},l={configuration:a.extend({},k)},m=l.configuration,n=function(a,b){this.bus=b,this.channel=a||m.DEFAULT_CHANNEL};n.prototype.subscribe=function(){return this.bus.subscribe({channel:this.channel,topic:1===arguments.length?arguments[0].topic:arguments[0],callback:1===arguments.length?arguments[0].callback:arguments[1]})},n.prototype.publish=function(){var b,c={};if("string"==typeof arguments[0]?(c.topic=arguments[0],c.data=arguments[1],b=arguments[2]):(c=arguments[0],b=arguments[1]),"object"!=typeof c)throw new Error("The first argument to ChannelDefinition.publish should be either an envelope object or a string topic.");c.headers=a.extend(c.headers||{resolverNoCache:m.resolverNoCache}),c.channel=this.channel,this.bus.publish(c,b)};var o=function(a,b,d){if(3!==arguments.length)throw new Error("You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.");if(0===b.length)throw new Error("Topics cannot be empty");this.channel=a,this.topic=b,this.callback=d,this.pipeline=[],this.cacheKeys=[],this._context=c},p=function(){var b;return function(c){var d=!1;return"string"==typeof c?(d=c===b,b=c):(d=a.isEqual(c,b),b=a.extend({},c)),!d}},q=function(){var b=[];return function(c){var d=!a.some(b,function(b){return a.isEqual(c,b)});return d&&b.push(c),d}};o.prototype={"catch":function(a){var b=this.callback,c=function(){try{b.apply(this,arguments)}catch(c){a(c,arguments[0])}};return this.callback=c,this},defer:function(){return this.delay(0)},disposeAfter:function(b){if("number"!=typeof b||0>=b)throw new Error("The value provided to disposeAfter (maxCalls) must be a number greater than zero.");var c=a.after(b,this.unsubscribe.bind(this));return this.pipeline.push(function(a,b,d){d(a,b),c()}),this},distinct:function(){return this.constraint(new q)},distinctUntilChanged:function(){return this.constraint(new p)},invokeSubscriber:function(a,b){if(!this.inactive){var c=this,d=c.pipeline,e=d.length,f=c._context,g=-1,h=!1;if(e){d=d.concat([c.callback]);var i=function j(a,b){g+=1,e>g?d[g].call(f,a,b,j):(c.callback.call(f,a,b),h=!0)};i(a,b,0)}else c.callback.call(f,a,b),h=!0;return h}},logError:function(){if(console){var a;a=console.warn?console.warn:console.log,this["catch"](a)}return this},once:function(){return this.disposeAfter(1)},subscribe:function(a){return this.callback=a,this},unsubscribe:function(){this.inactive||l.unsubscribe(this)},constraint:function(a){if("function"!=typeof a)throw new Error("Predicate constraint must be a function");return this.pipeline.push(function(b,c,d){a.call(this,b,c)&&d(b,c)}),this},constraints:function(b){var c=this;return a.each(b,function(a){c.constraint(a)}),c},context:function(a){return this._context=a,this},debounce:function(b,c){if("number"!=typeof b)throw new Error("Milliseconds must be a number");var d={};return!!c==!0&&(d.leading=!0,d.trailing=!1),this.pipeline.push(a.debounce(function(a,b,c){c(a,b)},b,d)),this},delay:function(a){if("number"!=typeof a)throw new Error("Milliseconds must be a number");var b=this;return b.pipeline.push(function(b,c,d){setTimeout(function(){d(b,c)},a)}),this},throttle:function(b){if("number"!=typeof b)throw new Error("Milliseconds must be a number");var c=function(a,b,c){c(a,b)};return this.pipeline.push(a.throttle(c,b)),this}};var r=(m.resolver={cache:{},regex:{},enableCache:!0,compare:function(b,c,d){var e,f,g,h=c+m.cacheKeyDelimiter+b,i=this.cache[h],j=d||{},k=this.enableCache&&!j.resolverNoCache;return i===!0?i:-1===b.indexOf("#")&&-1===b.indexOf("*")?(i=c===b,k&&(this.cache[h]=i),i):((f=this.regex[b])||(e="^"+a.map(b.split("."),function(a){var b="";return g&&(b="#"!==g?"\\.\\b":"\\b"),b+="#"===a?"[\\s\\S]*":"*"===a?"[^.]+":a,g=a,b}).join("")+"$",f=this.regex[b]=new RegExp(e)),i=f.test(c),k&&(this.cache[h]=i),i)},reset:function(){this.cache={},this.regex={}},purge:function(b){var c=this,d=m.cacheKeyDelimiter,e=function(a,e){var f=e.split(d),g=f[0],h=f[1];"undefined"!=typeof b.topic&&b.topic!==g||"undefined"!=typeof b.binding&&b.binding!==h||delete c.cache[e]},f=function(a,b){var e=b.split(d);0===l.getSubscribersFor({topic:e[0]}).length&&delete c.cache[b]};if("undefined"==typeof b)this.reset();else{var g=b.compact===!0?f:e;a.each(this.cache,g)}}},0),s=[],t=0,u=g.bind(c,"created"),v=g.bind(c,"removed");if(a.extend(l,{cache:{},subscriptions:{},wireTaps:[],ChannelDefinition:n,SubscriptionDefinition:o,channel:function(a){return new n(a,this)},addWireTap:function(a){var b=this;return b.wireTaps.push(a),function(){var c=b.wireTaps.indexOf(a);-1!==c&&b.wireTaps.splice(c,1)}},noConflict:function(){if("undefined"==typeof window||"undefined"!=typeof window&&"function"==typeof define&&define.amd)throw new Error("noConflict can only be used in browser clients which aren't using AMD modules");return b.postal=i,this},getSubscribersFor:function(b){var c=[],d=this;return a.each(d.subscriptions,function(d){a.each(d,function(d){c=c.concat(a.filter(d,h(b,m.resolver)))})}),c},publish:function(b,c){++r;var e=b.channel=b.channel||m.DEFAULT_CHANNEL,g=b.topic;b.timeStamp=new Date,this.wireTaps.length&&a.each(this.wireTaps,function(a){a(b.data,b,r)});var h=e+m.cacheKeyDelimiter+g,i=this.cache[h],j=0,k=0;if(i)a.each(i,function(a){a.invokeSubscriber(b.data,b)?k++:j++});else{var l=f(g,this.cache,h,function(a){a.invokeSubscriber(b.data,b)?k++:j++},b);a.each(this.subscriptions[e],function(b){a.each(b,l)})}0===--r&&d(),c&&c({activated:k,skipped:j})},reset:function(){this.unsubscribeFor(),m.resolver.reset(),this.subscriptions={},this.cache={}},subscribe:function(b){var c,d=this.subscriptions,e=new o(b.channel||m.DEFAULT_CHANNEL,b.topic,b.callback),g=d[e.channel],h=e.channel.length;g||(g=d[e.channel]={}),c=d[e.channel][e.topic],c||(c=d[e.channel][e.topic]=[]),c.push(e);var i=this.cache;return a.each(a.keys(i),function(a){a.substr(0,h)===e.channel&&f(a.split(m.cacheKeyDelimiter)[1],i,a)(e)}),m.enableSystemMessages&&this.publish(u(e)),e},unsubscribe:function(){for(var b,c,d,f,g=arguments.length,h=0;g>h;h++){if(b=arguments[h],b.inactive=!0,r)return void s.push(b);if(c=this.subscriptions[b.channel],d=c&&c[b.topic]){var i=d.length;for(f=0;i>f;){if(d[f]===b){d.splice(f,1);break}f+=1}if(0===d.length&&(delete c[b.topic],a.keys(c).length||delete this.subscriptions[b.channel]),b.cacheKeys&&b.cacheKeys.length)for(var j;j=b.cacheKeys.pop();)a.each(this.cache[j],e(b,j,this.cache));if("function"==typeof m.resolver.purge){var k=m.autoCompactResolver===!0?0:"number"==typeof m.autoCompactResolver?m.autoCompactResolver-1:!1;k>=0&&t===k?(m.resolver.purge({compact:!0}),t=0):k>=0&&k>t&&(t+=1)}}m.enableSystemMessages&&this.publish(v(b))}},unsubscribeFor:function(a){var b=[];this.subscriptions&&(b=this.getSubscribersFor(a),this.unsubscribe.apply(this,b))}}),b&&Object.prototype.hasOwnProperty.call(b,"__postalReady__")&&a.isArray(b.__postalReady__))for(;b.__postalReady__.length;)b.__postalReady__.shift().onReady(l);return l});